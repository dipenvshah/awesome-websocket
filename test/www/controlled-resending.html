<!DOCTYPE HTML>
<meta charset="UTF-8">

<html lang="en" ng-app='theApp'>
<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <link rel="stylesheet" href="//code.jquery.com/qunit/qunit-1.14.0.css">
  <title>reconnecting websocket tests</title>
  <script src="//code.jquery.com/qunit/qunit-1.14.0.js"></script>
  <script type="text/javascript">
    window.debug = true;
  </script>
  <script type="text/javascript" src="js/reconn.js"> </script>
  <script type="text/javascript" src="js/lodash.js"> </script>
  <script type="text/javascript">
    var ReconnectingResendingWebSocket = require("reconnecting-websocket").ReconnectingResendingWebSocket;
    var ReconnectingWebSocket = require("reconnecting-websocket").ReconnectingWebSocket;
    var Q = require('q');

    QUnit.asyncTest('message sent while disonnected makes it through', function(assert) {
      expect(3);
      var testWs = new ReconnectingResendingWebSocket("ws://localhost:8082/socket");
      var controllingWs = new ReconnectingWebSocket("ws://localhost:8080/socket");
      testWs.gotPid        = Q.defer();
      controllingWs.gotPid = Q.defer();
      serverDead           = Q.defer();

      function onOpen(evt) {
        this.send("what's your pid");
      };

      function messageHandler(evt) {
        data = JSON.parse(evt.data);
        if (data.pid){
          this.pid = data.pid;
          this.gotPid.resolve();
        } else if ( data.type === "dead" && data.childPort === 8082){
          serverDead.resolve();
        }
      };

      controllingWs.onopen = onOpen.bind(controllingWs);
      controllingWs.onmessage = messageHandler.bind(controllingWs);
      controllingWs.gotPid.promise.then(function(){
        controllingWs.send(JSON.stringify({type: "start", port: 8082}));
      });

      testWs.onopen = function(){
        assert.ok(true, "connected");
        testWs.send("die");
      }
      testWs.onclose = function(){
        assert.ok(true, 'closed');
        QUnit.start(); 
      }
      serverDead.promise.then(function(){
        // send the message to a dead server
        testWs.send('{"type":"echo", "echoThis":"please"}');
        // restart
        controllingWs.send(JSON.stringify({type: "start", port: 8082}));
      });
      
      testWs.onmessage = function(message){
        var mo = JSON.parse(message.data);
        if ( mo.type === "echo" ){
          assert.ok(mo.echoThis === "please", "message");
          testWs.close();
        }
      }

    });

  </script>
</head>
<body>
  <div id="qunit"></div>
  <div id="qunit-fixture"></div>
</body>
</html>
