<!DOCTYPE HTML>
<meta charset="UTF-8">

<html lang="en" ng-app='theApp'>
<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <link rel="stylesheet" href="//code.jquery.com/qunit/qunit-1.14.0.css">
  <title>reconnecting websocket tests</title>
  <script src="//code.jquery.com/qunit/qunit-1.14.0.js"></script>
  <script type="text/javascript">
    window.debug = true;
  </script>
  <script type="text/javascript" src="js/reconn.js"> </script>
  <script type="text/javascript" src="js/lodash.js"> </script>
  <script type="text/javascript">
    var Q = require('q');
    var ReconnectingResendingWebSocket = require("reconnecting-websocket").ReconnectingResendingWebSocket;
    var ReconnectingWebSocket = require("reconnecting-websocket").ReconnectingWebSocket;
    function SocketServerController(port){
      this.port = port;
      this.servers = {};
      var ws = new ReconnectingWebSocket("ws://localhost:" + this.port + "/socket");
      this.connected = Q.defer();

      this.sendMessage = function(message){
        if ( typeof(message) != "string" ){
          ws.send(JSON.stringify(message));
        } else {
          ws.send(message);
        } }.bind(this);
      this.send = this.sendMessage;

      ws.onmessage = function(message){
        message = JSON.parse(message.data);
        if ( message.type === "started" ){
          this.servers[message.childPort].started.resolve();
        } else if ( message.type === "dead" ){
          this.servers[message.childPort].stopped.resolve();
          delete this.servers[message.childPort]
        } else if ( message.type === "connected" ){
          this.connected.resolve();
        } }.bind(this);

      // kills the controlling server
      this.die = function() { this.sendMessage("die") }.bind(this);

      // starts a new server for a given port, or retuns the infor for the one
      // we have
      this.start = function(port) {
        if ( this.servers[port] ){
          return this.servers[port];
        }
        this.servers[port] = { started: Q.defer(), stopped: Q.defer() };
        this.sendMessage({type: "start", port: port});
        return this.servers[port];
      }.bind(this);

      this.kill = function(port){ this.sendMessage({type: "kill", port: port}); }.bind(this);
    }

    QUnit.asyncTest('message sent while disonnected makes it through', function(assert) {
      expect(3);
      var testWs = new ReconnectingResendingWebSocket("ws://localhost:8082/socket");
      var controllingWs = new SocketServerController(8080);
      var testServer;

      controllingWs.connected.promise.then(function(){
        testServer = controllingWs.start(8082);
        // once the test server stopps, then send our message, since that's
        // what we're testing
        testServer.stopped.promise.then(function(){
          // send the message to a dead server
          testWs.send('{"type":"echo", "echoThis":"please"}');
          // restart
          testServer = controllingWs.start(8082);
        });
      });

      testWs.onopen = function(){
        assert.ok(true, "connected");
        testWs.send("die");
      }
      testWs.onclose = function(){
        assert.ok(true, 'closed');
        controllingWs.kill(8082);
        QUnit.start(); 
      }

      testWs.onmessage = function(message){
        var mo = JSON.parse(message.data);
        if ( mo.type === "echo" ){
          assert.ok(mo.echoThis === "please", "message");
          testWs.close();
        }
      }

    });

  </script>
</head>
<body>
  <div id="qunit"></div>
  <div id="qunit-fixture"></div>
</body>
</html>
