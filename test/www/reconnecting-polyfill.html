<!DOCTYPE HTML>
<meta charset="UTF-8">

<html lang="en" ng-app='theApp'>
<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <link rel="stylesheet" href="//code.jquery.com/qunit/qunit-1.14.0.css">
  <title>reconnecting polyfill websocket tests</title>
  <script src="//code.jquery.com/qunit/qunit-1.14.0.js"></script>
  <script type="text/javascript">
    window.debug = true;
  </script>
  <script type="text/javascript" src="js/reconn.js"> </script>
  <script type="text/javascript" src="js/lodash.js"> </script>
  <script type="text/javascript">
    require("reconnecting-websocket").MakeWebSocketReconnecting();

    QUnit.test('should have unmake', function(assert){
      assert.ok(UnMakeWebSocketReconnecting, 'unmake available');
    });

    QUnit.asyncTest('connect on create', function(assert) {
      expect(2);
      var ws = new WebSocket("ws://localhost:8080/socket")
      ws.onopen = function() {
        assert.ok(true, 'socket opened');
        ws.close();
      };
      ws.onclose = function() {
        assert.ok(true, 'close event called');
        QUnit.start();
      }
    });

    QUnit.asyncTest('will reconnect', function(assert) {
      expect(4);
      var ws = new WebSocket("ws://localhost:8080/socket");
      ws.onopen = function() {
        assert.ok(true, 'socket opened');
        ws.send('die');
      };
      // depending on timings and such we'll get some number of error
      // events, we really just want to make sure we get _at least_ one
      // error event here...
      ws.onerror = _.once(function(){assert.ok(true, 'error event raised')});
      ws.onreconnect = function() {
        assert.ok(true, 'socket reconnected')
        ws.close();
      };
      ws.onclose = function() {
        assert.ok(true, 'close event called');
        QUnit.start();
      }
    });

    QUnit.asyncTest('receives message', function(assert) {
      expect(2);
      var ws = new WebSocket("ws://localhost:8080/socket")
      ws.onopen = function() {
        ws.send('ping');
      };
      var closeAfterMessages = _.after(2, ws.close);
      ws.onmessage = function(message){
        if (message.data === "connected"){
          assert.ok(true, 'received connected message');
        } else {
          assert.ok(message.data === "pong", 'received message');
        }
        closeAfterMessages(); 
      };
      ws.onclose = function() {
        QUnit.start();
      }
    });
  </script>
</head>
<body>
  <div id="qunit"></div>
  <div id="qunit-fixture"></div>
</body>
</html>
